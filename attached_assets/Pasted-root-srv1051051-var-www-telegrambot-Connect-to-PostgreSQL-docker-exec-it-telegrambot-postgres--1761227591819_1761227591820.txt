root@srv1051051:/var/www/telegrambot# # Connect to PostgreSQL
docker exec -it telegrambot-postgres-1 psql -U teleshopuser -d teleshop

# Then run these SQL commands:
psql (16.10)
Type "help" for help.

teleshop=# -- Drop the old constraint (key only)
teleshop=# ALTER TABLE bot_settings DROP CONSTRAINT IF EXISTS bot_settings_key_unique;
ALTER TABLE
teleshop=# -- Add the new composite constraint (bot_id + key)
teleshop=# ALTER TABLE bot_settings ADD CONSTRAINT bot_settings_bot_id_key_unique UNIQUE (bot_id, key);
ERROR:  relation "bot_settings_bot_id_key_unique" already exists
teleshop=# \d bot_settings
                             Table "public.bot_settings"
   Column   |            Type             | Collation | Nullable |      Default      
------------+-----------------------------+-----------+----------+-------------------
 id         | character varying           |           | not null | gen_random_uuid()
 key        | text                        |           | not null | 
 value      | text                        |           | not null | 
 updated_at | timestamp without time zone |           | not null | now()
 bot_id     | text                        |           | not null | 
Indexes:
    "bot_settings_pkey" PRIMARY KEY, btree (id)
    "bot_settings_bot_id_key_unique" UNIQUE CONSTRAINT, btree (bot_id, key)

teleshop=# \q
root@srv1051051:/var/www/telegrambot# docker-compose restart bot1 bot2
WARN[0000] The "BOT5_TOKEN" variable is not set. Defaulting to a blank string. 
WARN[0000] The "BOT6_TOKEN" variable is not set. Defaulting to a blank string. 
WARN[0000] The "BOT8_TOKEN" variable is not set. Defaulting to a blank string. 
WARN[0000] The "BOT9_TOKEN" variable is not set. Defaulting to a blank string. 
WARN[0000] The "BOT1_TOKEN" variable is not set. Defaulting to a blank string. 
WARN[0000] The "BOT4_TOKEN" variable is not set. Defaulting to a blank string. 
WARN[0000] The "BOT3_TOKEN" variable is not set. Defaulting to a blank string. 
WARN[0000] The "BOT7_TOKEN" variable is not set. Defaulting to a blank string. 
WARN[0000] The "BOT10_TOKEN" variable is not set. Defaulting to a blank string. 
[+] Restarting 2/2
 âœ” Container telegrambot-bot1-1  Started                                                                          0.5s 
 âœ” Container telegrambot-bot2-1  Started                                                                          0.5s 
root@srv1051051:/var/www/telegrambot# docker-compose logs bot2 --tail=30 --follow
WARN[0000] The "BOT1_TOKEN" variable is not set. Defaulting to a blank string. 
WARN[0000] The "BOT4_TOKEN" variable is not set. Defaulting to a blank string. 
WARN[0000] The "BOT5_TOKEN" variable is not set. Defaulting to a blank string. 
WARN[0000] The "BOT9_TOKEN" variable is not set. Defaulting to a blank string. 
WARN[0000] The "BOT3_TOKEN" variable is not set. Defaulting to a blank string. 
WARN[0000] The "BOT6_TOKEN" variable is not set. Defaulting to a blank string. 
WARN[0000] The "BOT7_TOKEN" variable is not set. Defaulting to a blank string. 
WARN[0000] The "BOT8_TOKEN" variable is not set. Defaulting to a blank string. 
WARN[0000] The "BOT10_TOKEN" variable is not set. Defaulting to a blank string. 
telegrambot-bot2-1  |   schema: 'public',
telegrambot-bot2-1  |   table: 'bot_settings',
telegrambot-bot2-1  |   column: undefined,
telegrambot-bot2-1  |   dataType: undefined,
telegrambot-bot2-1  |   constraint: 'bot_settings_key_unique',
telegrambot-bot2-1  |   file: 'nbtinsert.c',
telegrambot-bot2-1  |   line: '666',
telegrambot-bot2-1  |   routine: '_bt_check_unique'
telegrambot-bot2-1  | }
telegrambot-bot2-1  | 09:24:18 AM [express] âŒ Bot initialization failed: duplicate key value violates unique constraint "bot_settings_key_unique"
telegrambot-bot2-1  | 09:24:18 AM [express] ğŸ”„ Server continues running with admin dashboard only
telegrambot-bot2-1  | npm warn config optional Use `--omit=optional` to exclude optional dependencies, or
telegrambot-bot2-1  | npm warn config `--include=optional` to include them.
telegrambot-bot2-1  | npm warn config
telegrambot-bot2-1  | npm warn config       Default value does install optional deps unless otherwise omitted.
telegrambot-bot2-1  | 
telegrambot-bot2-1  | > workspace@1.0.0 start
telegrambot-bot2-1  | > NODE_ENV=production tsx server/index.ts
telegrambot-bot2-1  | 
telegrambot-bot2-1  | âœ… Initializing storage for Bot ID: 8061353646
telegrambot-bot2-1  | 09:52:13 AM [express] ğŸ”§ Setting up API routes...
telegrambot-bot2-1  | 09:52:13 AM [express] âœ… API routes registered
telegrambot-bot2-1  | 09:52:13 AM [express] ğŸ”§ Setting up static file serving...
telegrambot-bot2-1  | 09:52:13 AM [express] âœ… Static file serving configured
telegrambot-bot2-1  | 09:52:13 AM [express] ğŸš€ Server started on port 5000
telegrambot-bot2-1  | 09:52:13 AM [express] âœ… Health check available at / and /health
telegrambot-bot2-1  | 09:52:13 AM [express] ğŸ–¥ï¸  Admin dashboard ready
telegrambot-bot2-1  | 09:52:13 AM [express] ğŸ” Bot initialization starting in background...
telegrambot-bot2-1  | 09:52:13 AM [express] âœ… Bot token auto-configured from environment
telegrambot-bot2-1  | Cleared webhook
telegrambot-bot2-1  | 09:52:23 AM [express] âŒ Bot initialization failed: Bot initialization timeout
telegrambot-bot2-1  | 09:52:23 AM [express] ğŸ”„ Server continues running with admin dashboard only
telegrambot-bot2-1  | 09:52:25 AM [express] ğŸš€ Telegram bot initialized and running
